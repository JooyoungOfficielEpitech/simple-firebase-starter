rules_version = '2';

// Firebase Storage 보안 규칙
// 사용자별 파일 접근 제어 및 파일 타입/크기 제한 적용
service firebase.storage {
  match /b/{bucket}/o {
    
    // === 게시글 이미지 업로드 규칙 ===
    // 경로: posts/{filename}
    match /posts/{fileName} {
      allow read: if true;  // 모든 사용자가 게시글 이미지 읽기 가능
      
      allow write: if 
        // 1. 사용자가 인증되어 있어야 함
        request.auth != null
        
        // 2. 파일 타입 제한 (이미지만 허용)
        && (
          request.resource.contentType.matches('image/jpeg') ||
          request.resource.contentType.matches('image/jpg') ||
          request.resource.contentType.matches('image/png') ||
          request.resource.contentType.matches('image/webp')
        )
        
        // 3. 파일 크기 제한 (5MB 이하)
        && request.resource.size < 5 * 1024 * 1024
        
        // 4. 파일명 안전성 검증 (알파벳, 숫자, 하이픈, 언더스코어, 점만 허용)
        && fileName.matches('^[a-zA-Z0-9._-]+\\.(jpg|jpeg|png|webp)$');
      
      allow delete: if 
        // 1. 사용자가 인증되어 있어야 함
        request.auth != null
        
        // 2. 본인이 업로드한 파일만 삭제 가능 (메타데이터 기반)
        && (
          resource.metadata.uploadedBy == request.auth.uid ||
          resource.metadata.firebaseStorageDownloadTokens != null
        );
    }
    
    // === 사용자 프로필 이미지 규칙 ===
    // 경로: profiles/{userId}/{filename}
    match /profiles/{userId}/{fileName} {
      allow read: if true;  // 모든 사용자가 프로필 이미지 읽기 가능
      
      allow write: if 
        // 1. 본인의 프로필 폴더에만 업로드 가능
        request.auth.uid == userId
        
        // 2. 파일 타입 제한 (이미지만 허용)
        && (
          request.resource.contentType.matches('image/jpeg') ||
          request.resource.contentType.matches('image/jpg') ||
          request.resource.contentType.matches('image/png') ||
          request.resource.contentType.matches('image/webp')
        )
        
        // 3. 파일 크기 제한 (2MB 이하 - 프로필 이미지는 더 작게)
        && request.resource.size < 2 * 1024 * 1024
        
        // 4. 파일명 안전성 검증
        && fileName.matches('^[a-zA-Z0-9._-]+\\.(jpg|jpeg|png|webp)$');
      
      allow delete: if 
        // 본인의 프로필 이미지만 삭제 가능
        request.auth.uid == userId;
    }
    
    // === 조직 관련 파일 규칙 ===
    // 경로: organizations/{orgId}/{filename}
    match /organizations/{orgId}/{fileName} {
      allow read: if true;  // 모든 사용자가 조직 이미지 읽기 가능
      
      allow write: if 
        // 1. 사용자가 인증되어 있어야 함
        request.auth != null
        
        // 2. TODO: 실제 구현 시 조직 소유자/관리자 권한 확인 필요
        // get(/databases/$(database)/documents/organizations/$(orgId)).data.ownerId == request.auth.uid
        
        // 3. 파일 타입 제한 (이미지만 허용)
        && (
          request.resource.contentType.matches('image/jpeg') ||
          request.resource.contentType.matches('image/jpg') ||
          request.resource.contentType.matches('image/png') ||
          request.resource.contentType.matches('image/webp')
        )
        
        // 4. 파일 크기 제한 (3MB 이하)
        && request.resource.size < 3 * 1024 * 1024
        
        // 5. 파일명 안전성 검증
        && fileName.matches('^[a-zA-Z0-9._-]+\\.(jpg|jpeg|png|webp)$');
      
      allow delete: if 
        // TODO: 조직 소유자/관리자만 삭제 가능
        request.auth != null;
    }
    
    // === 임시 파일 업로드 규칙 ===
    // 경로: temp/{userId}/{filename}
    match /temp/{userId}/{fileName} {
      allow read, write, delete: if
        // 1. 본인의 임시 폴더에만 접근 가능
        request.auth.uid == userId

        // 2. 파일 타입 제한 (더 넓은 범위 허용)
        && (
          request.resource.contentType.matches('image/.*') ||
          request.resource.contentType.matches('application/pdf') ||
          request.resource.contentType.matches('text/.*')
        )

        // 3. 파일 크기 제한 (10MB 이하)
        && request.resource.size < 10 * 1024 * 1024

        // 4. 파일명 안전성 검증
        && fileName.matches('^[a-zA-Z0-9._-]+\\.[a-zA-Z0-9]+$');
    }

    // === 뮤지컬 노래방 음악 파일 규칙 ===
    // 경로: karaoke/songs/{filename}
    match /karaoke/songs/{fileName} {
      allow read: if true;  // 모든 사용자가 음악 파일 읽기 가능

      allow write: if
        // 1. 사용자가 인증되어 있어야 함 (관리자만 업로드)
        request.auth != null

        // 2. 파일 타입 제한 (오디오 파일만 허용)
        && (
          request.resource.contentType.matches('audio/mpeg') ||
          request.resource.contentType.matches('audio/mp3') ||
          request.resource.contentType.matches('audio/wav') ||
          request.resource.contentType.matches('audio/ogg')
        )

        // 3. 파일 크기 제한 (20MB 이하)
        && request.resource.size < 20 * 1024 * 1024

        // 4. 파일명 안전성 검증 (.mp3, .wav, .ogg만 허용)
        && fileName.matches('^[a-zA-Z0-9._-]+\\.(mp3|wav|ogg)$');

      allow delete: if
        // 관리자만 삭제 가능
        request.auth != null;
    }

    // === MusicXML 파일 규칙 ===
    // 경로: karaoke/musicxml/{filename}
    match /karaoke/musicxml/{fileName} {
      allow read: if true;  // 모든 사용자가 MusicXML 파일 읽기 가능

      allow write: if
        // 1. 사용자가 인증되어 있어야 함
        request.auth != null

        // 2. 파일 타입 제한 (XML 파일만 허용)
        && (
          request.resource.contentType.matches('application/xml') ||
          request.resource.contentType.matches('text/xml') ||
          request.resource.contentType.matches('application/vnd.recordare.musicxml')
        )

        // 3. 파일 크기 제한 (5MB 이하)
        && request.resource.size < 5 * 1024 * 1024

        // 4. 파일명 안전성 검증 (.musicxml, .xml만 허용)
        && fileName.matches('^[a-zA-Z0-9._-]+\\.(musicxml|xml)$');

      allow delete: if
        request.auth != null;
    }
    
    // === 기본 거부 규칙 ===
    // 위에 매칭되지 않는 모든 경로에 대해서는 접근 거부
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

// === 보안 규칙 설명 ===
//
// 1. 경로별 접근 제어:
//    - posts/: 게시글 이미지 (모든 사용자 읽기, 인증된 사용자 쓰기)
//    - profiles/{userId}/: 개인 프로필 이미지 (본인만 쓰기/삭제)
//    - organizations/{orgId}/: 조직 이미지 (조직 관리자만 쓰기/삭제)
//    - temp/{userId}/: 임시 파일 (본인만 접근)
//
// 2. 파일 타입 제한:
//    - 이미지: jpg, jpeg, png, webp
//    - 임시 파일: 이미지, PDF, 텍스트 파일
//
// 3. 파일 크기 제한:
//    - 게시글 이미지: 5MB
//    - 프로필 이미지: 2MB
//    - 조직 이미지: 3MB
//    - 임시 파일: 10MB
//
// 4. 파일명 보안:
//    - 안전한 문자만 허용 (영문, 숫자, 점, 하이픈, 언더스코어)
//    - 확장자 검증
//
// 5. 사용자 인증:
//    - 모든 쓰기/삭제 작업에 인증 필요
//    - 읽기는 공개 (게시글/프로필 이미지)