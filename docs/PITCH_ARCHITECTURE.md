# Pitch 조절 기능 아키텍처

## 시스템 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                      MusicPlayer.tsx                        │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                    State Management                    │  │
│  │  • pitchEnabled: boolean                              │  │
│  │  • pitchSemitones: number (-6 ~ +6)                   │  │
│  │  • expoSound: Audio.Sound | null                      │  │
│  │  • isPitchReady: boolean                              │  │
│  └───────────────────────────────────────────────────────┘  │
│                            │                                │
│         ┌──────────────────┼──────────────────┐             │
│         ▼                  ▼                  ▼             │
│  ┌─────────────┐   ┌──────────────┐   ┌─────────────┐      │
│  │ TrackPlayer │   │  expo-av     │   │ usePitchShift│     │
│  │  (기본 재생)  │   │  Sound       │   │   Hook       │     │
│  │             │   │ (Pitch 전용)  │   │             │     │
│  └─────────────┘   └──────────────┘   └─────────────┘      │
│         │                  │                  │             │
│         └──────────────────┼──────────────────┘             │
│                            │                                │
│                   ┌────────▼────────┐                       │
│                   │ PitchControl UI │                       │
│                   │  • Slider       │                       │
│                   │  • Presets      │                       │
│                   │  • Toggle       │                       │
│                   └─────────────────┘                       │
└─────────────────────────────────────────────────────────────┘
```

## 재생 모드 전환 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                     일반 재생 모드                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │ TrackPlayer: 활성 (재생/일시정지 가능)                   │  │
│  │ expo-av Sound: 비활성 (로드만 완료)                     │  │
│  │ Pitch 조절: 적용 안 됨                                 │  │
│  │ A-B 루프: 정상 동작                                   │  │
│  └───────────────────────────────────────────────────────┘  │
│                            │                                │
│                  [Pitch Toggle ON]                          │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              전환 프로세스                              │  │
│  │  1. 현재 TrackPlayer 위치 저장                         │  │
│  │  2. TrackPlayer 일시정지                              │  │
│  │  3. expo-av를 저장된 위치로 이동                       │  │
│  │  4. expo-av 재생 시작                                 │  │
│  └───────────────────────────────────────────────────────┘  │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   Pitch 조절 모드                       │  │
│  │  TrackPlayer: 비활성 (일시정지 상태)                    │  │
│  │  expo-av Sound: 활성 (재생/일시정지 가능)              │  │
│  │  Pitch 조절: 반음 단위 적용                           │  │
│  │  A-B 루프: 비활성 (TrackPlayer 기능)                  │  │
│  └───────────────────────────────────────────────────────┘  │
│                            │                                │
│                 [Pitch Toggle OFF]                          │
│                            ▼                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              역전환 프로세스                            │  │
│  │  1. 현재 expo-av 위치 저장                            │  │
│  │  2. expo-av 일시정지                                  │  │
│  │  3. TrackPlayer를 저장된 위치로 이동                   │  │
│  │  4. 이전 재생 상태면 TrackPlayer 재생                  │  │
│  └───────────────────────────────────────────────────────┘  │
│                            ▼                                │
│                    [일반 재생 모드로 복귀]                    │
└─────────────────────────────────────────────────────────────┘
```

## Pitch 계산 공식

```
┌─────────────────────────────────────────────────────────────┐
│                     반음(Semitone) 계산                      │
│                                                             │
│  공식: rate = 2^(semitones / 12)                            │
│                                                             │
│  예시:                                                      │
│  • +2 반음: rate = 2^(2/12) ≈ 1.122 (약 12% 빠르게)        │
│  • -2 반음: rate = 2^(-2/12) ≈ 0.891 (약 11% 느리게)       │
│  • +12 반음 (1옥타브): rate = 2^(12/12) = 2.0 (2배 빠르게)  │
│                                                             │
│  shouldCorrectPitch = true:                                 │
│  → 템포 유지, Pitch만 변경                                  │
│                                                             │
│  PitchCorrectionQuality.High:                               │
│  → 최고 음질 (iOS 완벽 지원)                                │
└─────────────────────────────────────────────────────────────┘
```

## 컴포넌트 상호작용 다이어그램

```
┌──────────────────┐
│  MusicPlayer     │
└────────┬─────────┘
         │
         ├─────────────────────────────────┐
         │                                 │
┌────────▼─────────┐           ┌──────────▼──────────┐
│ usePitchShift    │           │  PitchControl UI    │
│ Hook             │           │                     │
│                  │           │  ┌───────────────┐  │
│ • expo-av Sound  │◄──────────┼──┤ Slider        │  │
│ • semitones      │           │  │ (-6 ~ +6)     │  │
│ • enabled        │           │  └───────────────┘  │
│                  │           │                     │
│ ┌──────────────┐ │           │  ┌───────────────┐  │
│ │ setRateAsync │ │           │  │ Preset Buttons│  │
│ │ rate = 2^    │ │           │  │ • 남성 -2     │  │
│ │ (s/12)       │ │           │  │ • 여성 +2     │  │
│ └──────────────┘ │           │  │ • 초기화 0    │  │
│                  │           │  └───────────────┘  │
│ ┌──────────────┐ │           │                     │
│ │shouldCorrect │ │           │  ┌───────────────┐  │
│ │Pitch = true  │ │           │  │ Toggle ON/OFF │  │
│ └──────────────┘ │           │  └───────────────┘  │
└──────────────────┘           └─────────────────────┘
```

## 데이터 플로우

```
사용자 입력 (슬라이더 또는 프리셋 버튼)
         │
         ▼
setPitchSemitones(newValue)
         │
         ▼
usePitchShift Hook 감지 (useEffect)
         │
         ▼
rate 계산: 2^(semitones / 12)
         │
         ▼
expoSound.setRateAsync(rate, true, High)
         │
         ▼
Pitch 변경 적용 (템포 유지)
         │
         ▼
UI 업데이트 (현재 값 표시)
```

## 에러 처리 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                      에러 시나리오                            │
│                                                             │
│  1. expo-av Sound 로드 실패                                 │
│     → isPitchReady = false                                  │
│     → Pitch Control UI 비활성화                             │
│     → console.error 로그                                    │
│                                                             │
│  2. setRateAsync 실패                                       │
│     → console.error 로그                                    │
│     → 이전 rate 유지                                        │
│     → 사용자에게 Alert (선택적)                              │
│                                                             │
│  3. TrackPlayer-expo-av 동기화 실패                         │
│     → console.error 로그                                    │
│     → 수동 위치 조정 필요                                   │
│     → 재생 중단 방지                                        │
│                                                             │
│  4. Android 음질 저하                                       │
│     → 경고 메시지 표시                                      │
│     → 기능은 계속 동작                                      │
│     → 사용자 선택에 맡김                                    │
└─────────────────────────────────────────────────────────────┘
```

## 메모리 관리

```
┌─────────────────────────────────────────────────────────────┐
│                      리소스 관리                              │
│                                                             │
│  초기화:                                                     │
│  • TrackPlayer: 기존 초기화 유지                             │
│  • expo-av Sound: 컴포넌트 마운트 시 로드                    │
│  • 메모리: 약 +5~10MB (오디오 파일 크기에 따라)              │
│                                                             │
│  사용 중:                                                    │
│  • 일반 모드: TrackPlayer만 활성                             │
│  • Pitch 모드: expo-av Sound만 활성                         │
│  • 동시 활성화 방지로 메모리 절약                            │
│                                                             │
│  정리 (cleanup):                                            │
│  • 컴포넌트 언마운트 시 expo-av Sound unload                │
│  • TrackPlayer는 전역 유지 (다른 화면에서도 사용)             │
│  • 메모리 누수 방지                                         │
└─────────────────────────────────────────────────────────────┘
```

## 성능 최적화 전략

```
┌─────────────────────────────────────────────────────────────┐
│                      최적화 포인트                            │
│                                                             │
│  1. expo-av Sound 미리 로드                                 │
│     • 컴포넌트 마운트 시 즉시 로드                           │
│     • 사용자가 Pitch 활성화 시 즉시 재생 가능                │
│                                                             │
│  2. 불필요한 리렌더링 방지                                   │
│     • useEffect 의존성 최소화                               │
│     • useMemo, useCallback 활용 (필요 시)                   │
│                                                             │
│  3. 동시 재생 방지                                          │
│     • pitchEnabled 상태로 플레이어 전환                      │
│     • 메모리 및 CPU 절약                                    │
│                                                             │
│  4. 디바운싱 (선택적)                                       │
│     • 슬라이더 조작 시 너무 빈번한 setRateAsync 방지         │
│     • 부드러운 UX 유지                                      │
└─────────────────────────────────────────────────────────────┘
```

---

**참고**: 이 아키텍처는 Option A (TrackPlayer + expo-av 병행) 기반입니다.
